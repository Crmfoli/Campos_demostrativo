<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard RC Engenharia</title>
    <style>
        /* Estilos Essenciais */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; }
        .header { background: #fff; padding: 1em 2em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-title { display: flex; align-items: center; gap: 1em; }
        .logo-header { height: 40px; }
        .header h1 { color: #0056b3; margin: 0; font-size: 1.5em; }
        .btn-voltar { font-size: 0.9em; font-weight: bold; color: #007bff; text-decoration: none; background-color: transparent; border: 2px solid #007bff; padding: 0.5em 1em; border-radius: 20px; transition: all 0.3s ease; }
        .btn-voltar:hover { background-color: #007bff; color: white; }
        
        /* Layout Simplificado */
        .main-container { display: flex; justify-content: center; /* Centraliza o card */ padding: 1.5em; }
        .card { background: #fff; padding: 1.5em; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); width: 100%; max-width: 800px; /* Define uma largura máxima */ }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 0.5em; margin-top: 0; font-size: 1.2em; }
        
        /* Estilos da Tabela */
        table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        th, td { padding: 0.7em; text-align: left; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        th { background-color: #007bff; color: white; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo da Empresa" class="logo-header">
            <h1>Dashboard RC Engenharia</h1>
        </div>
        <div>
            <a href="/mapa" class="btn-voltar">⬅️ Voltar ao Mapa</a>
        </div>
    </div>

    <div class="main-container">
        <div class="card">
            <h2>Últimas Leituras</h2>
            <table id="real-time-table">
                <thead><tr><th>Horário</th><th>Umidade</th><th>Temp.</th><th>Chuva</th></tr></thead>
                <tbody id="tabela-dados"></tbody>
            </table>
        </div>
    </div>

    <script>
        let updateInterval;
        const MAX_LINHAS_TABELA = 15;

        // Função para renderizar a tabela com os dados iniciais
        function renderizarTabela(dados) {
            const tbody = document.getElementById('tabela-dados');
            tbody.innerHTML = ''; // Limpa a tabela antes de adicionar novas linhas

            // Pega as últimas N linhas e as exibe, com a mais recente no topo
            dados.slice(-MAX_LINHAS_TABELA).reverse().forEach(leitura => {
                const newRow = tbody.insertRow(); // Insere no final, mas como os dados estão invertidos, a ordem fica correta
                newRow.innerHTML = `<td>${leitura.timestamp_completo}</td><td>${leitura.umidade}</td><td>${leitura.temperatura}</td><td>${leitura.chuva}</td>`;
            });
        }
        
        // Função para buscar e adicionar apenas a última leitura à tabela
        async function buscarAtualizacao() {
            try {
                const response = await fetch('/api/dados_atuais');
                if (!response.ok) return; // Se a resposta não for OK, sai da função
                const novaLeitura = await response.json();
                
                const tbody = document.getElementById('tabela-dados');
                
                // Adiciona a nova leitura no topo da tabela
                const newRow = tbody.insertRow(0);
                newRow.innerHTML = `<td>${novaLeitura.timestamp_completo}</td><td>${novaLeitura.umidade}</td><td>${novaLeitura.temperatura}</td><td>${novaLeitura.chuva}</td>`;
                
                // Remove a última linha se a tabela exceder o número máximo de linhas
                while (tbody.rows.length > MAX_LINHAS_TABELA) {
                    tbody.deleteRow(tbody.rows.length - 1);
                }
            } catch (error) {
                console.error("Erro na atualização em tempo real:", error);
            }
        }
        
        // Função principal que carrega os dados iniciais e inicia a atualização automática
        async function carregarDados() {
            try {
                const response = await fetch(`/api/dados`);
                if (!response.ok) throw new Error('Falha ao buscar dados');
                const dados = await response.json();
                
                renderizarTabela(dados);
                
                // Limpa qualquer intervalo anterior e inicia um novo
                if (updateInterval) clearInterval(updateInterval);
                updateInterval = setInterval(buscarAtualizacao, 2000); // Atualiza a cada 2 segundos
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            }
        }
        
        // Inicia o processo quando a página termina de carregar
        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>
</body>
</html>
